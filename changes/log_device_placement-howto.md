# Rational to change `model_server` to enable log_device_placement

We need to be able to rewrite node-to-device assignment in already trained models. Enabling `log_device_placement` during exporting trained model like done [here](https://github.com/knodir/serving/commit/604334e7ab67994736da2b68a34decc71cafbef2) for `mnist_saved_model.py` is not enough for following two reasons:
1) The flag to `tf.Session()` only tells to log node-to-device assignment during model export. It does not necessarily mean that such placement will be honored during the serving.
2) What if the user only has saved_model.pb? We still want to change node-to-device for better serving.

We need to instrument model_server to output the node-to-device placement whenever a model is loaded from `saved_model.pb`.


# Detective work: how did I find log_device_placement for the model_server?

Looked at model_servers' [code](https://github.com/tensorflow/serving/blob/master/tensorflow_serving/model_servers/main.cc#L187) and found out there is a class `tensorflow::RunOptions()` with setter methods such as `run_options.set_timeout_in_ms()`. My intuition was to find out a similar logging options for the device placement and set it up. From older TensorFlow training experience I knew `log_device_placement` option exist. Found the definition of the `RunOptions` and came across the protobuf definition at [config.proto](https://github.com/tensorflow/tensorflow/blob/r1.6/tensorflow/core/protobuf/config.proto#L366). Then I Googled "tensorflow RunOptions set_timeout_in_ms" to see the definition of methods and came across the doxygen style documentation for the [`RunOptions`](http://bytedeco.org/javacpp-presets/tensorflow/apidocs/org/bytedeco/javacpp/tensorflow.RunOptions.html) class.

I looked through the `config.proto` and saw [`log_device_placement`](https://github.com/tensorflow/tensorflow/blob/r1.6/tensorflow/core/protobuf/config.proto#L342) flag is indeed under [`ConfigProto`](https://github.com/tensorflow/tensorflow/blob/r1.6/tensorflow/core/protobuf/config.proto#L265) object. Now I want to see if `ConfigProto` has a setter method for `log_device_placement`. I go back to the earlier doxygen style documentation page and manually change filename in the URL from `tensorflow.RunOptions.html` to [`tensorflow.ConfigProto.html`](http://bytedeco.org/javacpp-presets/tensorflow/apidocs/org/bytedeco/javacpp/tensorflow.ConfigProto.html) and indeed see [`set_log_device_placement`](http://bytedeco.org/javacpp-presets/tensorflow/apidocs/org/bytedeco/javacpp/tensorflow.ConfigProto.html#set_log_device_placement-boolean-) method. I got lucky with these URLs.


Now I should find a way to feed `ConfigProto` to the model_server. Quick Googling `tensorflow serving ConfigProto` pointed to an existing [GitHub issue](https://github.com/tensorflow/tensorflow/issues/16716) which has following line `tensorflow::ConfigProto& config = sessionOptions.config` This tells me that `ConfigProto` is accessible over `sessionOptions`. Again, quick Googling "tensorflow SessionOptions" pointed me to the definition of the [`SessionOptions`](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/public/session_options.h#L28) class which indeed has [`ConfigProto config`](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/public/session_options.h#L58) member.

Now my mission is to find `SessionOptions` or similar object in model_server such that I can access `config.log_device_placement`. During my initial browsing of the model_servers code I remember seeing [`session_bundle_config`](https://github.com/tensorflow/serving/blob/master/tensorflow_serving/model_servers/main.cc#L429) which was being used as `session_bundle_config.mutable_session_config()->set_intra_op_parallelism_threads()`. Just by the wording similarity I suspect `mutable_session_config()` to be refer to the `SessionOptions` object. Googling definition of the `SessionBundleConfig` shows me that it indeed has a field [`ConfigProto session_config`](https://github.com/tensorflow/serving/blob/master/tensorflow_serving/servables/tensorflow/session_bundle_config.proto#L21). Thus, my theory is `session_bundle_config.mutable_session_config()` should give me `ConfigProto` and I should be able to mutate it by calling `set_log_device_placement(true)`. I do the [change](https://github.com/knodir/serving/commit/590059963f12e67ae56990616c21e914da6fb567#diff-53fe26927596e47ad1110b4e1d166723R404) and bingo!